name: Release

on:
  push:
    tags:
      - "v*"

concurrency:
  group: release-${{ github.ref }}
  cancel-in-progress: true

permissions:
  contents: write

jobs:
  build:
    strategy:
      fail-fast: false
      matrix:
        include:
          - platform: ubuntu-22.04
            rust_target: x86_64-unknown-linux-gnu
            ffmpeg_os: linux
          - platform: macos-latest
            rust_target: aarch64-apple-darwin
            ffmpeg_os: macos
          - platform: macos-15-intel
            rust_target: x86_64-apple-darwin
            ffmpeg_os: macos
          - platform: windows-latest
            rust_target: x86_64-pc-windows-msvc
            ffmpeg_os: windows
            bundles: nsis

    runs-on: ${{ matrix.platform }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      # ─── Version Sync from Git Tag ──────────────────────────

      - name: Sync version from git tag
        shell: bash
        run: |
          VERSION="${GITHUB_REF_NAME#v}"
          echo "Releasing version: $VERSION"

          # Update package.json
          node -e "
            const fs = require('fs');
            const pkg = JSON.parse(fs.readFileSync('package.json', 'utf-8'));
            pkg.version = '${VERSION}';
            fs.writeFileSync('package.json', JSON.stringify(pkg, null, 2) + '\n');
          "

          # Update src-tauri/tauri.conf.json
          node -e "
            const fs = require('fs');
            const conf = JSON.parse(fs.readFileSync('src-tauri/tauri.conf.json', 'utf-8'));
            conf.version = '${VERSION}';
            fs.writeFileSync('src-tauri/tauri.conf.json', JSON.stringify(conf, null, 2) + '\n');
          "

          # Update src-tauri/Cargo.toml
          node -e "
            const fs = require('fs');
            let toml = fs.readFileSync('src-tauri/Cargo.toml', 'utf-8');
            toml = toml.replace(/^version = \"[^\"]*\"/m, 'version = \"${VERSION}\"');
            fs.writeFileSync('src-tauri/Cargo.toml', toml);
          "

          echo "Updated all config files to version $VERSION"

      # ─── System Dependencies ────────────────────────────────

      - name: Install Linux dependencies
        if: matrix.ffmpeg_os == 'linux'
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            libwebkit2gtk-4.1-dev \
            libappindicator3-dev \
            librsvg2-dev \
            patchelf \
            libgtk-3-dev \
            libsoup-3.0-dev \
            libjavascriptcoregtk-4.1-dev

      # ─── Toolchains ────────────────────────────────────────

      - name: Setup Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: ${{ matrix.rust_target }}

      - name: Rust cache
        uses: swatinem/rust-cache@v2
        with:
          workspaces: src-tauri -> target

      - name: Setup Bun
        uses: oven-sh/setup-bun@v2

      - name: Install frontend dependencies
        run: bun install

      # ─── Download FFmpeg/FFprobe Sidecar Binaries ───────────

      - name: Download ffmpeg (Linux)
        if: matrix.ffmpeg_os == 'linux'
        run: |
          curl -L -o ffmpeg.tar.xz \
            "https://github.com/BtbN/FFmpeg-Builds/releases/download/latest/ffmpeg-master-latest-linux64-lgpl.tar.xz"
          tar xf ffmpeg.tar.xz
          FFMPEG_DIR=$(find . -maxdepth 1 -type d -name "ffmpeg-*" | head -1)
          cp "${FFMPEG_DIR}/bin/ffmpeg"  "src-tauri/binaries/ffmpeg-${{ matrix.rust_target }}"
          cp "${FFMPEG_DIR}/bin/ffprobe" "src-tauri/binaries/ffprobe-${{ matrix.rust_target }}"
          chmod +x src-tauri/binaries/ff*
          rm -rf ffmpeg.tar.xz "${FFMPEG_DIR}"

      - name: Download ffmpeg (macOS)
        if: matrix.ffmpeg_os == 'macos'
        run: |
          FFMPEG_VERSION="n7.1-2"

          if [ "${{ matrix.rust_target }}" = "aarch64-apple-darwin" ]; then
            FFMPEG_ARCH="osx-arm64"
          else
            FFMPEG_ARCH="osx-x64"
          fi

          BASE_URL="https://github.com/shaka-project/static-ffmpeg-binaries/releases/download/${FFMPEG_VERSION}"

          curl -L -o "src-tauri/binaries/ffmpeg-${{ matrix.rust_target }}" "${BASE_URL}/ffmpeg-${FFMPEG_ARCH}"
          curl -L -o "src-tauri/binaries/ffprobe-${{ matrix.rust_target }}" "${BASE_URL}/ffprobe-${FFMPEG_ARCH}"

          chmod +x src-tauri/binaries/ffmpeg-${{ matrix.rust_target }}
          chmod +x src-tauri/binaries/ffprobe-${{ matrix.rust_target }}

          # Verify binaries are real executables, not HTML error pages
          file "src-tauri/binaries/ffmpeg-${{ matrix.rust_target }}"
          ls -lh src-tauri/binaries/ffmpeg-${{ matrix.rust_target }} src-tauri/binaries/ffprobe-${{ matrix.rust_target }}

      - name: Download ffmpeg (Windows)
        if: matrix.ffmpeg_os == 'windows'
        shell: pwsh
        run: |
          Invoke-WebRequest -Uri `
            "https://github.com/BtbN/FFmpeg-Builds/releases/download/latest/ffmpeg-master-latest-win64-lgpl.zip" `
            -OutFile ffmpeg.zip
          Expand-Archive ffmpeg.zip -DestinationPath ffmpeg-extracted
          $dir = Get-ChildItem ffmpeg-extracted -Directory | Select-Object -First 1
          Copy-Item "$($dir.FullName)\bin\ffmpeg.exe"  "src-tauri\binaries\ffmpeg-${{ matrix.rust_target }}.exe"
          Copy-Item "$($dir.FullName)\bin\ffprobe.exe" "src-tauri\binaries\ffprobe-${{ matrix.rust_target }}.exe"
          Remove-Item -Recurse -Force ffmpeg.zip, ffmpeg-extracted

      - name: Verify sidecar binaries
        shell: bash
        run: |
          if [ "${{ matrix.ffmpeg_os }}" = "windows" ]; then
            EXT=".exe"
          else
            EXT=""
          fi
          for bin in ffmpeg ffprobe; do
            FILE="src-tauri/binaries/${bin}-${{ matrix.rust_target }}${EXT}"
            if [ ! -f "$FILE" ]; then
              echo "FATAL: ${FILE} missing"
              exit 1
            fi
            SIZE=$(stat --format='%s' "$FILE" 2>/dev/null || stat -f '%z' "$FILE")
            echo "OK: ${FILE} (${SIZE} bytes)"

            # Ensure binary is not suspiciously small (< 1MB = likely broken)
            if [ "$SIZE" -lt 1000000 ]; then
              echo "FATAL: ${FILE} is only ${SIZE} bytes — expected 50MB+. Binary may be corrupt or a symlink."
              exit 1
            fi
          done

      - name: Pre-cache NSIS for Tauri (Windows)
        if: matrix.ffmpeg_os == 'windows'
        shell: pwsh
        run: |
          $nsisPath = "$env:LOCALAPPDATA\tauri\NSIS"
          if (Test-Path $nsisPath) {
            Write-Host "NSIS already cached at $nsisPath"
          } else {
            New-Item -ItemType Directory -Force -Path "$env:LOCALAPPDATA\tauri" | Out-Null

            # Download NSIS with retries
            $nsisUrl = "https://github.com/tauri-apps/binary-releases/releases/download/nsis-3.11/nsis-3.11.zip"
            $zipPath = "$env:RUNNER_TEMP\nsis-3.11.zip"
            $maxRetries = 5
            for ($i = 1; $i -le $maxRetries; $i++) {
              try {
                Write-Host "Downloading NSIS (attempt $i/$maxRetries)..."
                Invoke-WebRequest -Uri $nsisUrl -OutFile $zipPath -MaximumRetryCount 3 -RetryIntervalSec 5
                break
              } catch {
                Write-Host "Attempt $i failed: $_"
                if ($i -eq $maxRetries) { throw "Failed to download NSIS after $maxRetries attempts" }
                Start-Sleep -Seconds (10 * $i)
              }
            }

            # Extract and rename to expected path
            Expand-Archive $zipPath -DestinationPath "$env:LOCALAPPDATA\tauri"
            Rename-Item "$env:LOCALAPPDATA\tauri\nsis-3.11" "NSIS"
            Remove-Item $zipPath -Force

            # Download NSIS Tauri Utils plugin with retries
            $pluginUrl = "https://github.com/tauri-apps/nsis-tauri-utils/releases/download/nsis_tauri_utils-v0.5.3/nsis_tauri_utils.dll"
            $pluginDir = "$nsisPath\Plugins\x86-unicode\additional"
            New-Item -ItemType Directory -Force -Path $pluginDir | Out-Null
            for ($i = 1; $i -le $maxRetries; $i++) {
              try {
                Write-Host "Downloading NSIS Tauri Utils plugin (attempt $i/$maxRetries)..."
                Invoke-WebRequest -Uri $pluginUrl -OutFile "$pluginDir\nsis_tauri_utils.dll" -MaximumRetryCount 3 -RetryIntervalSec 5
                break
              } catch {
                Write-Host "Attempt $i failed: $_"
                if ($i -eq $maxRetries) { throw "Failed to download NSIS plugin after $maxRetries attempts" }
                Start-Sleep -Seconds (10 * $i)
              }
            }

            Write-Host "NSIS cached successfully at $nsisPath"
            Get-ChildItem $nsisPath | Select-Object Name
          }

      # ─── Build & Release ────────────────────────────────────

      - name: Build Tauri app
        uses: tauri-apps/tauri-action@v0.6.1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tagName: ${{ github.ref_name }}
          releaseName: "CachePhoenix ${{ github.ref_name }}"
          releaseBody: |
            ## Installation

            | Platform | Download |
            |----------|----------|
            | Windows | `.exe` installer |
            | macOS (Apple Silicon) | `.dmg` |
            | macOS (Intel) | `.dmg` |
            | Linux | `.deb` or `.AppImage` |

            ### macOS Users
            macOS may show **"CachePhoenix is damaged and can't be opened"** — this is because the app is not notarized with Apple. To fix this, open Terminal and run:
            ```
            xattr -cr /Applications/CachePhoenix.app
            ```
            Then open the app normally. You only need to do this once.
            ### Notes
            - ffmpeg and ffprobe are bundled — no external dependencies required.
          releaseDraft: false
          prerelease: false
          args: --target ${{ matrix.rust_target }} ${{ matrix.bundles && format('--bundles {0}', matrix.bundles) || '' }}
